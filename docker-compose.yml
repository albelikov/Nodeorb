version: '3.8'

services:
  # PostgreSQL with PostGIS extension
  postgres:
    image: postgis/postgis:18-alpine
    container_name: nodeorb-postgres
    environment:
      POSTGRES_DB: nodeorb
      POSTGRES_USER: nodeorb
      POSTGRES_PASSWORD: nodeorb_dev_password
      POSTGRES_MULTIPLE_DATABASES: scm_db,oms_db,wms_db,fms_db,tms_db
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql
    networks:
      - nodeorb-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U nodeorb"]
      interval: 10s
      timeout: 5s
      retries: 5

  # pgAdmin for database management
  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: nodeorb-pgadmin
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@nodeorb.com
      PGADMIN_DEFAULT_PASSWORD: admin
      PGADMIN_LISTEN_PORT: 80
    ports:
      - "5050:80"
    volumes:
      - pgadmin_data:/var/lib/pgadmin
    networks:
      - nodeorb-network
    depends_on:
      - postgres

  # Apache Kafka (опционально для недели 3+)
  # zookeeper:
  #   image: confluentinc/cp-zookeeper:7.5.0
  #   container_name: nodeorb-zookeeper
  #   environment:
  #     ZOOKEEPER_CLIENT_PORT: 2181
  #     ZOOKEEPER_TICK_TIME: 2000
  #   networks:
  #     - nodeorb-network

  # kafka:
  #   image: confluentinc/cp-kafka:7.5.0
  #   container_name: nodeorb-kafka
  #   depends_on:
  #     - zookeeper
  #   ports:
  #     - "9092:9092"
  #   environment:
  #     KAFKA_BROKER_ID: 1
  #     KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
  #     KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:29092,PLAINTEXT_HOST://localhost:9092
  #     KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
  #     KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
  #     KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
  #   networks:
  #     - nodeorb-network

  # SCM Service (Security & Compliance Management)
  scm-service:
    build:
      context: ./scm-service
      dockerfile: Dockerfile
    container_name: nodeorb-scm
    environment:
      SPRING_PROFILES_ACTIVE: dev
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/scm_db
      SPRING_DATASOURCE_USERNAME: nodeorb
      SPRING_DATASOURCE_PASSWORD: nodeorb_dev_password
    ports:
      - "8081:8080"
    networks:
      - nodeorb-network
    depends_on:
      postgres:
        condition: service_healthy
    restart: unless-stopped

  # OMS Service (Order Management System)
  oms-service:
    build:
      context: ./oms-service
      dockerfile: Dockerfile
    container_name: nodeorb-oms
    environment:
      SPRING_PROFILES_ACTIVE: dev
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/oms_db
      SPRING_DATASOURCE_USERNAME: nodeorb
      SPRING_DATASOURCE_PASSWORD: nodeorb_dev_password
      SCM_SERVICE_URL: http://scm-service:8080
    ports:
      - "8082:8080"
    networks:
      - nodeorb-network
    depends_on:
      postgres:
        condition: service_healthy
      scm-service:
        condition: service_started
    restart: unless-stopped

  # WMS Service (Warehouse Management System)
  wms-service:
    build:
      context: ./wms-service
      dockerfile: Dockerfile
    container_name: nodeorb-wms
    environment:
      SPRING_PROFILES_ACTIVE: dev
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/wms_db
      SPRING_DATASOURCE_USERNAME: nodeorb
      SPRING_DATASOURCE_PASSWORD: nodeorb_dev_password
      SCM_SERVICE_URL: http://scm-service:8080
      OMS_SERVICE_URL: http://oms-service:8080
    ports:
      - "8083:8080"
    networks:
      - nodeorb-network
    depends_on:
      postgres:
        condition: service_healthy
      scm-service:
        condition: service_started
      oms-service:
        condition: service_started
    restart: unless-stopped

  # FMS Service (Fleet Management System)
  fms-service:
    build:
      context: ./fms-service
      dockerfile: Dockerfile
    container_name: nodeorb-fms
    environment:
      SPRING_PROFILES_ACTIVE: dev
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/fms_db
      SPRING_DATASOURCE_USERNAME: nodeorb
      SPRING_DATASOURCE_PASSWORD: nodeorb_dev_password
      SCM_SERVICE_URL: http://scm-service:8080
      WMS_SERVICE_URL: http://wms-service:8080
    ports:
      - "8084:8080"
    networks:
      - nodeorb-network
    depends_on:
      postgres:
        condition: service_healthy
      scm-service:
        condition: service_started
    restart: unless-stopped

  # TMS Service (Transportation Management System)
  tms-service:
    build:
      context: ./tms-service
      dockerfile: Dockerfile
    container_name: nodeorb-tms
    environment:
      SPRING_PROFILES_ACTIVE: dev
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/tms_db
      SPRING_DATASOURCE_USERNAME: nodeorb
      SPRING_DATASOURCE_PASSWORD: nodeorb_dev_password
      SCM_SERVICE_URL: http://scm-service:8080
      FMS_SERVICE_URL: http://fms-service:8080
    ports:
      - "8085:8080"
    networks:
      - nodeorb-network
    depends_on:
      postgres:
        condition: service_healthy
      scm-service:
        condition: service_started
      fms-service:
        condition: service_started
    restart: unless-stopped

  # Admin Backend
  admin-backend:
    build:
      context: ./admin-backend
      dockerfile: Dockerfile
    container_name: nodeorb-admin
    environment:
      SPRING_PROFILES_ACTIVE: dev
      SCM_SERVICE_URL: http://scm-service:8080
      OMS_SERVICE_URL: http://oms-service:8080
      WMS_SERVICE_URL: http://wms-service:8080
      FMS_SERVICE_URL: http://fms-service:8080
      TMS_SERVICE_URL: http://tms-service:8080
      KEYCLOAK_URL: http://localhost:8086
    ports:
      - "8080:8080"
    networks:
      - nodeorb-network
    depends_on:
      - scm-service
      - oms-service
      - wms-service
      - fms-service
      - tms-service
    restart: unless-stopped

networks:
  nodeorb-network:
    driver: bridge

volumes:
  postgres_data:
  pgadmin_data:
