syntax = "proto3";

package trust.v1;

option go_package = "github.com/albelikov/nodeorb/scm-service/api/grpc/trust/v1;trustv1";

import "google/protobuf/timestamp.proto";
import "google/protobuf/empty.proto";

// TrustService manages trust scores and compliance validation
service TrustService {
  // ValidateManualCostEntry validates manual cost entry against market median
  rpc ValidateManualCostEntry(ManualCostEntryRequest) returns (ManualCostEntryResponse);
  
  // GetTrustScore retrieves current trust score for a user
  rpc GetTrustScore(GetTrustScoreRequest) returns (TrustScoreResponse);
  
  // SubmitAppeal submits an appeal for rejected cost entry
  rpc SubmitAppeal(AppealRequest) returns (AppealResponse);
  
  // GetEvidencePackage retrieves evidence package for an order
  rpc GetEvidencePackage(GetEvidencePackageRequest) returns (EvidencePackageResponse);
}

// ManualCostEntryRequest represents a manual cost entry validation request
message ManualCostEntryRequest {
  string user_id = 1;
  string order_id = 2;
  string event_id = 3;
  double materials_cost = 4;
  double labor_cost = 5;
  string currency = 6;
  google.protobuf.Timestamp timestamp = 7;
}

// ManualCostEntryResponse represents the validation result
message ManualCostEntryResponse {
  string event_id = 1;
  ValidationStatus status = 2;
  double deviation = 3;
  double median_price = 4;
  double suggested_median = 5;
  bool audit_required = 6;
  string reason = 7;
  google.protobuf.Timestamp validated_at = 8;
}

// ValidationStatus represents the status of validation
enum ValidationStatus {
  VALIDATION_STATUS_UNSPECIFIED = 0;
  VALIDATION_STATUS_APPROVED = 1;
  VALIDATION_STATUS_AUDIT_REQUIRED = 2;
  VALIDATION_STATUS_REJECTED = 3;
}

// GetTrustScoreRequest retrieves trust score for a user
message GetTrustScoreRequest {
  string user_id = 1;
}

// TrustScoreResponse contains trust score information
message TrustScoreResponse {
  string user_id = 1;
  double trust_score = 2;
  TrustLevel trust_level = 3;
  google.protobuf.Timestamp last_updated = 4;
  SecurityRequirements security_requirements = 5;
}

// TrustLevel represents the trust level
enum TrustLevel {
  TRUST_LEVEL_UNSPECIFIED = 0;
  TRUST_LEVEL_CRITICAL = 1;
  TRUST_LEVEL_LOW = 2;
  TRUST_LEVEL_MEDIUM = 3;
  TRUST_LEVEL_HIGH = 4;
}

// SecurityRequirements defines security requirements based on trust level
message SecurityRequirements {
  bool requires_biometrics = 1;
  bool requires_appeal = 2;
  bool requires_manual_review = 3;
  repeated string restricted_actions = 4;
}

// AppealRequest represents an appeal submission
message AppealRequest {
  string event_id = 1;
  string user_id = 2;
  string justification = 3;
  repeated EvidenceItem evidence_items = 4;
}

// EvidenceItem represents a piece of evidence
message EvidenceItem {
  string id = 1;
  EvidenceType type = 2;
  string url = 3;
  string description = 4;
  google.protobuf.Timestamp uploaded_at = 5;
}

// EvidenceType represents the type of evidence
enum EvidenceType {
  EVIDENCE_TYPE_UNSPECIFIED = 0;
  EVIDENCE_TYPE_DOCUMENT = 1;
  EVIDENCE_TYPE_PHOTO = 2;
  EVIDENCE_TYPE_INVOICE = 3;
  EVIDENCE_TYPE_TEXT = 4;
}

// AppealResponse represents the appeal result
message AppealResponse {
  string appeal_id = 1;
  AppealStatus status = 2;
  string message = 3;
  google.protobuf.Timestamp submitted_at = 4;
}

// AppealStatus represents the status of an appeal
enum AppealStatus {
  APPEAL_STATUS_UNSPECIFIED = 0;
  APPEAL_STATUS_SUBMITTED = 1;
  APPEAL_STATUS_APPROVED = 2;
  APPEAL_STATUS_REJECTED = 3;
  APPEAL_STATUS_REVIEWED = 4;
}

// GetEvidencePackageRequest retrieves evidence package for an order
message GetEvidencePackageRequest {
  string order_id = 1;
}

// EvidencePackageResponse contains the evidence package
message EvidencePackageResponse {
  string order_id = 1;
  google.protobuf.Timestamp generated_at = 2;
  repeated ComplianceEvent events = 3;
  repeated ManualEntryValidation validations = 4;
  repeated AccessCheck access_checks = 5;
  repeated GeofenceCheck geofence_checks = 6;
  repeated HashChainNode hash_chain = 7;
  string root_hash = 8;
  string merkle_root = 9;
  string signature = 10;
}

// ComplianceEvent represents a compliance event
message ComplianceEvent {
  string event_id = 1;
  string event_type = 2;
  google.protobuf.Timestamp timestamp = 3;
  string user_id = 4;
  map<string, string> details = 5;
}

// ManualEntryValidation represents a manual entry validation
message ManualEntryValidation {
  string id = 1;
  string user_id = 2;
  string order_id = 3;
  double materials_cost = 4;
  double labor_cost = 5;
  string currency = 6;
  ValidationStatus risk_verdict = 7;
  double ai_confidence_score = 8;
  bool requires_appeal = 9;
  AppealStatus appeal_status = 10;
  google.protobuf.Timestamp created_at = 11;
}

// AccessCheck represents an access check
message AccessCheck {
  string id = 1;
  string user_id = 2;
  string order_id = 3;
  bool access_granted = 4;
  google.protobuf.Timestamp timestamp = 5;
  string reason = 6;
}

// GeofenceCheck represents a geofence check
message GeofenceCheck {
  string id = 1;
  string user_id = 2;
  string order_id = 3;
  bool is_inside = 4;
  double latitude = 5;
  double longitude = 6;
  google.protobuf.Timestamp timestamp = 7;
  string violation_reason = 8;
}

// HashChainNode represents a node in the hash chain
message HashChainNode {
  string id = 1;
  string type = 2;
  string hash = 3;
  string previous_hash = 4;
  google.protobuf.Timestamp timestamp = 5;
}